<idea-plugin allow-bundled-update="true">
    <resource-bundle>messages.AutoDevBundle</resource-bundle>

    <depends>com.intellij.modules.platform</depends>
    <depends>Git4Idea</depends>

    <extensions defaultExtensionNs="com.intellij">
        <applicationConfigurable parentId="tools" instance="cc.unitmesh.devti.settings.AutoDevSettingsConfigurable"
                                 id="cc.unitmesh.devti.settings.AutoDevSettingsConfigurable"
                                 displayName="AutoDev"/>

                <applicationService
                        serviceInterface="cc.unitmesh.devti.editor.LLMInlayManager"
                        serviceImplementation="cc.unitmesh.devti.editor.LLMInlayManagerImpl" />

        <applicationService serviceImplementation="cc.unitmesh.devti.settings.AutoDevSettingsState"/>

        <runConfigurationProducer
                implementation="cc.unitmesh.devti.runconfig.command.AutoDevFeatureConfigurationProducer"/>
        <runConfigurationProducer
                implementation="cc.unitmesh.devti.runconfig.command.CompositeAutoBaseRunConfigurationProducer"/>
        <configurationType implementation="cc.unitmesh.devti.runconfig.AutoDevConfigurationType"/>

        <!-- Run Configurations -->
        <programRunner implementation="cc.unitmesh.devti.runconfig.AutoDevCommandRunner"/>

        <toolWindow id="DevTiFlow" secondary="true" icon="AllIcons.Toolwindows.WebToolWindow" anchor="right"
                    factoryClass="cc.unitmesh.devti.gui.DevtiFlowToolWindowFactory"/>

        <intentionAction>
            <className>cc.unitmesh.devti.intentions.AIAssistantIntention</className>
            <categoryKey>Intention.category.llm</categoryKey>
        </intentionAction>
    </extensions>

    <extensionPoints>
        <extensionPoint qualifiedName="cc.unitmesh.aiAssistantIntention"
                        beanClass="com.intellij.codeInsight.intention.IntentionActionBean"
                        dynamic="true">
            <with tag="className" implements="com.intellij.codeInsight.intention.IntentionAction"/>
        </extensionPoint>

        <extensionPoint qualifiedName="cc.unitmesh.fileContextBuilder"
                        beanClass="com.intellij.lang.LanguageExtensionPoint" dynamic="true">
            <with attribute="implementationClass"
                  implements="cc.unitmesh.devti.context.builder.FileContextBuilder"/>
        </extensionPoint>

        <extensionPoint qualifiedName="cc.unitmesh.classContextBuilder"
                        beanClass="com.intellij.lang.LanguageExtensionPoint" dynamic="true">
            <with attribute="implementationClass"
                  implements="cc.unitmesh.devti.context.builder.ClassContextBuilder"/>
        </extensionPoint>

        <extensionPoint qualifiedName="cc.unitmesh.methodContextBuilder"
                        beanClass="com.intellij.lang.LanguageExtensionPoint" dynamic="true">
            <with attribute="implementationClass"
                  implements="cc.unitmesh.devti.context.builder.MethodContextBuilder"/>
        </extensionPoint>

        <extensionPoint qualifiedName="cc.unitmesh.variableContextBuilder"
                        beanClass="com.intellij.lang.LanguageExtensionPoint" dynamic="true">
            <with attribute="implementationClass"
                  implements="cc.unitmesh.devti.context.builder.VariableContextBuilder"/>
        </extensionPoint>

        <extensionPoint qualifiedName="cc.unitmesh.devFlowProvider"
                        interface="cc.unitmesh.devti.provider.DevFlowProvider"
                        dynamic="true"/>

        <!-- TODO: add build system extension point -->
        <extensionPoint qualifiedName="cc.unitmesh.techStackProvider"
                        interface="cc.unitmesh.devti.provider.TechStackProvider"
                        dynamic="true"/>

        <!-- TODO: find better way to share context -->
        <extensionPoint qualifiedName="cc.unitmesh.contextPrompter"
                        interface="cc.unitmesh.devti.provider.ContextPrompter"
                        dynamic="true"/>

        <extensionPoint qualifiedName="cc.unitmesh.promptStrategy"
                        interface="cc.unitmesh.devti.provider.PromptStrategy"
                        dynamic="true"/>
    </extensionPoints>

    <applicationListeners>
        <listener topic="cc.unitmesh.devti.editor.LLMInlayListener"
                  class="cc.unitmesh.devti.editor.LLMInlayGotItListener"/>
    </applicationListeners>

    <extensions defaultExtensionNs="cc.unitmesh">
        <aiAssistantIntention>
            <className>cc.unitmesh.devti.intentions.editor.CodeCompletionIntention</className>
            <categoryKey>Intention.category.llm</categoryKey>
        </aiAssistantIntention>
        <aiAssistantIntention>
            <className>cc.unitmesh.devti.intentions.editor.RefactorThisIntention</className>
            <categoryKey>Intention.category.llm</categoryKey>
        </aiAssistantIntention>
    </extensions>

    <actions>
<!--        <action id="llm.applyInlays"-->
<!--                class="cc.unitmesh.devti.actions.LLMApplyInlaysAction">-->
<!--            <keyboard-shortcut first-keystroke="TAB" keymap="$default"/>-->
<!--            <override-text place="MainMenu" text="Apply Completions to Editor"/>-->
<!--            <override-text place="EditorPopup" text="Accept"/>-->
<!--        </action>-->

        <group id="AutoDevIntentionsActionGroup" class="cc.unitmesh.devti.intentions.editor.IntentionsActionGroup">
            <add-to-group group-id="ShowIntentionsGroup" relative-to-action="ShowIntentionActions" anchor="after"/>
        </group>

        <group id="org.intellij.sdk.action.GroupedActions" popup="true" text="AutoDev" description="AutoDev">
            <action id="cc.unitmesh.devti.actions.chat.ChatBotExplainAction"
                    class="cc.unitmesh.devti.actions.chat.ChatBotExplainAction" text="Explain This"
                    description="Ask Chatbot about this code">
            </action>

            <action id="cc.unitmesh.devti.actions.chat.ChatBotRefactorAction"
                    class="cc.unitmesh.devti.actions.chat.ChatBotRefactorAction" text="Refactor This"
                    description="Ask Chatbot about this code">
            </action>

            <action id="cc.unitmesh.devti.actions.chat.ChatBotReviewAction"
                    class="cc.unitmesh.devti.actions.chat.ChatBotReviewAction" text="Review This"
                    description="Ask Chatbot about this code">
            </action>

            <action id="cc.unitmesh.devti.actions.chat.WriteTestAction"
                    class="cc.unitmesh.devti.actions.chat.WriteTestAction" text="Write Test for This"
                    description="Ask Chatbot about this code">
            </action>

            <action id="cc.unitmesh.devti.actions.chat.CreateDdlAction"
                    class="cc.unitmesh.devti.actions.chat.CreateDdlAction" text="Create DDL"
                    description="Ask Chatbot create DDL code">
            </action>

            <add-to-group group-id="EditorPopupMenu" anchor="first"/>
        </group>

        <action id="cc.unitmesh.devti.actions.chat.FixThisBotAction"
                class="cc.unitmesh.devti.actions.chat.FixThisBotAction" text="Fix This (AutoDev)"
                description="Ask Chatbot about this code">
            <add-to-group group-id="ConsoleEditorPopupMenu" anchor="first"/>
        </action>

        <action id="cc.unitmesh.devti.actions.chat.CommitMessageSuggestionAction"
                class="cc.unitmesh.devti.actions.chat.CommitMessageSuggestionAction" text="Commit Message (AutoDev)"
                description="Ask Chatbot about this code">
            <add-to-group group-id="Vcs.Commit.PrimaryCommitActions" anchor="first"/>
            <add-to-group group-id="Vcs.CommitExecutor.Actions" anchor="first"/>
            <add-to-group group-id="Vcs.MessageActionGroup"/>
        </action>


        <action id="cc.unitmesh.devti.actions.chat.CodeCompleteAction"
                class="cc.unitmesh.devti.actions.chat.CodeCompleteAction" text="Code Complete (AutoDev)"
                description="Ask Chatbot about this code">

            <add-to-group group-id="EditorPopupMenu" anchor="first"/>
        </action>
    </actions>
</idea-plugin>
